---
title: "Lab 9"
author: "Marc Brooks, Bo Liu, Shirley Mathur, Aasha Reddy"
date: "10/28/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
# load libraries
library(tidyverse)
library(lme4)
library(patchwork)
library(lubridate)
library(brms)
library(rstan)
library(knitr)
library(kableExtra)
library(corrplot)
```


```{r}
# load data
badgers <- read.csv("data/BadgersFarmSurveysNoNA.csv", sep = "")
```

# Notes from Chengxin
* Don't look at season or year of each farm (too much difference between the years)
* response - activity of badgers (binary)
* Don't need to do diagnostics/check model assupmtions 


# Introduction and Data

Management of badgers on Welsh and British farms is a controversial topic. While some argue that culling badger populations is necessary to control the spread of bovine tuberculosis, others argue that badgers are not the major cause of the spread of disease and that culling is inhumane, especially when badger vaccination strategies are an option.

We consider data from observational surveys of 36 farms over a period of three years. The data are available on Sakai under Resources, in the BadgersFarmSurveysNoNA.txt file. Each farm (identified by the variable farm_code_numeric) was observed up to eight times (once per season for a two year period). The primary outcome, Signs_in_yard, is whether badger activity (e.g., carcasses of their prey, badger feces, indications of digging) was present in the farmyard.

## Research questions
* What factors relate to presence of badger activity in the farmyard?
* Estimate the correlation over time in badger activity
    - every farm was recorded at diff times, if we take farm as group level, correlation within each farm will be corr of obs in each farm over time - take the farm as group level and look at corr within each farm
      - LOOK AT ICC (corr of obs within farm) - bc obs are already recorded over different times, this gives an idea of correlation over time of the response
* farm-specific heterogeneity in the tendency to have badger activity.
    - random intercept for farm

# EDA

## Examine outcome variable: signs_in_yard

First we examine how many 0's and 1's are in the outcome variable, signs_in_yard. We see that there are 230 0's and 43 1's. 

```{r}
table(badgers$Signs_in_yard)
```


## Examine fixed effects

We first note that we will not consider Season, time and survey, as each sample for each farm was taken at a different time point. Thus, the farm variable already accounts for a time effect. We would be unable to include all of these variables in our model since there would be multicollinearity. 

We examine plots of other predictors vs. our outcome (Signs_in_yard) to decide which variables we will consider in our model selection process (exhaustive search using BIC). We find the following variables show a difference between the counts of 0s and 1s in our outcome, and we consider them in our exhaustive search (see plots in appendix): no_setts_in_field, no_active_setts_in_field, no_cattle_cattle_in_buildings, accessible_feed__store_present, Hay straw, concentrates, Sugar beet, Molasses, accessible_feed_present, acessible_cattle_house_present, grass_silage, cereal_silage, cereal_grains


helpful
```{r}
# No setts in field
ggplot(badgers, aes(x = as.factor(Signs_in_yard), y = No_setts_in_fields, fill = Signs_in_yard)) + 
  geom_boxplot() + 
  theme(legend.position = "none") + 
  labs(x = "Signs in Yard", 
       title = "Signs_in_yard vs. No_setts_in_fields")
```

helpful
```{r}
# No active setts in fields
ggplot(badgers, aes(x = as.factor(Signs_in_yard), y = No_active_setts_in_fields, fill = Signs_in_yard)) + 
  geom_boxplot() + 
  theme(legend.position = "none") + 
  labs(x = "Signs in Yard", 
       title = "Signs_in_yard vs. No__active_setts_in_fields")
```

```{r}
# No_buildings
ggplot(badgers, aes(x = as.factor(Signs_in_yard), y = No_buildings, fill = Signs_in_yard)) +
  geom_boxplot() + 
  theme(legend.position = "none") + 
  labs(x = "Signs in Yard", 
       title = "Signs_in_yard vs. No_buildings")
```

helpful
```{r}
# No_cattle_in_buidlings_yard
ggplot(badgers, aes(x = as.factor(Signs_in_yard), y = No_cattle_in_buidlings_yard, fill = Signs_in_yard)) +
  geom_boxplot() + 
  theme(legend.position = "none") + 
  labs(x = "Signs in Yard", 
       title = "Signs_in_yard vs. No_cattle_in_buidlings_yard")
```

```{r}
# No_cattle_in_buidlings_yard
ggplot(badgers, aes(x = as.factor(Signs_in_yard), y = No_cattle_in_buidlings_yard, fill = Signs_in_yard)) +
  geom_boxplot() + 
  theme(legend.position = "none") + 
  labs(x = "Signs in Yard", 
       title = "Signs_in_yard vs. No_cattle_in_buidlings_yard")
```

```{r}
# season
table(badgers$Signs_in_yard, badgers$Season)
```


```{r}
# binary predictors
prop.table(table(badgers$Signs_in_yard, badgers$Accessible_feed_present))
prop.table(table(badgers$Signs_in_yard, badgers$Accessible_cattle_house_present))
prop.table(table(badgers$Signs_in_yard, badgers$Accessible_feed_store_present))
prop.table(table(badgers$Signs_in_yard, badgers$Grass_silage))
prop.table(table(badgers$Signs_in_yard, badgers$Cereal_silage))
prop.table(table(badgers$Signs_in_yard, badgers$HayStraw))
prop.table(table(badgers$Signs_in_yard, badgers$Cereal_grains))
prop.table(table(badgers$Signs_in_yard, badgers$Concentrates))
prop.table(table(badgers$Signs_in_yard, badgers$Proteinblocks))
prop.table(table(badgers$Signs_in_yard, badgers$Sugarbeet))
prop.table(table(badgers$Signs_in_yard, badgers$Vegetables))
prop.table(table(badgers$Signs_in_yard, badgers$Molasses))
```

include
```{r}
ggplot(badgers, aes(x = Accessible_feed_present, fill = as.factor(Signs_in_yard))) + 
  geom_bar(position = "fill") + 
  labs(title = "Accessible_feed_present vs. Signs_in_yard") + 
  theme(legend.position="bottom")
```

include
```{r}
ggplot(badgers, aes(x = Accessible_cattle_house_present, fill = as.factor(Signs_in_yard))) + 
  geom_bar(position = "fill") + 
  labs(title = "Accessible_cattle_house_present vs. Signs_in_yard") + 
  theme(legend.position="bottom")
```

helpful 
```{r}
ggplot(badgers, aes(x = Accessible_feed_store_present, fill = as.factor(Signs_in_yard))) + 
  geom_bar(position = "fill") + 
  labs(title = "Accessible_feed_store_present vs. Signs_in_yard") + 
  theme(legend.position="bottom")
```

```{r}
ggplot(badgers, aes(x = Grass_silage, fill = as.factor(Signs_in_yard))) + 
  geom_bar(position = "fill") + 
  labs(title = "Grass_silage vs. Signs_in_yard") + 
  theme(legend.position="bottom")
```

```{r}
ggplot(badgers, aes(x = Cereal_silage, fill = as.factor(Signs_in_yard))) + 
  geom_bar(position = "fill") + 
  labs(title = "Cereal_silage vs. Signs_in_yard") + 
  theme(legend.position="bottom")
```

helpful
```{r}
ggplot(badgers, aes(x = HayStraw, fill = as.factor(Signs_in_yard))) + 
  geom_bar(position = "fill") + 
  labs(title = "HayStraw vs. Signs_in_yard") + 
  theme(legend.position="bottom")
```

```{r}
ggplot(badgers, aes(x = Cereal_grains, fill = as.factor(Signs_in_yard))) + 
  geom_bar(position = "fill") + 
  labs(title = "Cereal_grains vs. Signs_in_yard") + 
  theme(legend.position="bottom")
```

helpful
```{r}
ggplot(badgers, aes(x = Concentrates, fill = as.factor(Signs_in_yard))) + 
  geom_bar(position = "fill") + 
  labs(title = "Concentrates vs. Signs_in_yard") + 
  theme(legend.position="bottom")
```


```{r}
ggplot(badgers, aes(x = Proteinblocks, fill = as.factor(Signs_in_yard))) + 
  geom_bar(position = "fill") + 
  labs(title = "Proteinblocks vs. Signs_in_yard") + 
  theme(legend.position="bottom")
```

helpful
```{r}
ggplot(badgers, aes(x = Sugarbeet, fill = as.factor(Signs_in_yard))) + 
  geom_bar(position = "fill") + 
  labs(title = "Sugarbeet vs. Signs_in_yard") + 
  theme(legend.position="bottom")
```


```{r}
ggplot(badgers, aes(x = Vegetables, fill = as.factor(Signs_in_yard))) + 
  geom_bar(position = "fill") + 
  labs(title = "Vegetables vs. Signs_in_yard") + 
  theme(legend.position="bottom")
```

helpful
```{r}
ggplot(badgers, aes(x = Molasses, fill = as.factor(Signs_in_yard))) + 
  geom_bar(position = "fill") + 
  labs(title = "Molasses vs. Signs_in_yard") + 
  theme(legend.position="bottom")
```


## Random intercept

```{r}
# farm code numeric
table(badgers$Signs_in_yard, badgers$farm_code_numeric)
```




# Model selection 

```{r}
exhaustive_search <- function(raw_model, vars, data) {
  y_name <- deparse(raw_model[[2]])
  group_name <- deparse(raw_model[[3]])
  id <- 0 : (2^length(vars) - 1)
  construct_model <- function(.id){
    subset <- (.id %/% 2^(0:(length(vars) - 1))) %% 2 == 1
    if (all(subset == F)){
      RHS <- paste0(c("1", group_name), collapse = ' + ')
    }
    else {
      RHS <- paste0(c(vars[subset], group_name), collapse = ' + ')
    }
    paste(y_name, RHS, sep = ' ~ ')
  }
  run_model <- function(.id){
    model_str <- construct_model(.id)
    model_formula <- as.formula(model_str)
    res <- glmer(model_formula, data = data,
                 family = binomial(link = "logit"))
    return (summary(res)$AICtab)
  }
  bind_cols(
    model = sapply(id, construct_model),
    as.data.frame(t(sapply(id, run_model)))
  )
}
```

```{r, message = F, echo = F}
ex_result_int <- exhaustive_search(
  raw_model = Signs_in_yard ~ (1 | farm_code_numeric),
  vars = c("No_setts_in_fields",
           "No_active_setts_in_fields",
           "No_cattle_in_buidlings_yard", 
           "Accessible_feed_store_present", 
           "HayStraw", 
           "Concentrates",
           "Sugarbeet", "Molasses", 
           "Accessible_feed_present", 
           "Accessible_cattle_house_present", 
           "Grass_silage", 
           "Cereal_silage", 
           "Cereal_grains"),
  data = badgers
)
```


```{r, echo = F}
ex_result_int %>% arrange(BIC) %>% head(10) %>%
  select(1, 3) %>%
  kbl(caption = "Exhaustive search of fixed effects using BIC") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                latex_options = "HOLD_position")
```
# unable to converge

```{r}
m1 <- glmer(Signs_in_yard ~ No_active_setts_in_fields + factor(HayStraw) +
        (1 | farm_code_numeric), data = badgers, 
      family = binomial(link = "logit"), 
      control = glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 2e5)))
```


Bayesian model converges

```{r}
brm(Signs_in_yard ~ No_active_setts_in_fields + factor(HayStraw) +
        (1 + Year | farm_code_numeric), 
    data = badgers, 
    family = binomial, 
    control = list(adapt_delta = 0.95))
```



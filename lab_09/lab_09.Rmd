---
title: "Lab 9"
author: "Marc Brooks, Bo Liu, Shirley Mathur, Aasha Reddy"
date: "10/28/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
# load libraries
library(tidyverse)
library(lme4)
library(patchwork)
library(lubridate)
library(brms)
library(rstan)
library(knitr)
library(kableExtra)
library(corrplot)
```


```{r}
# load data
badgers <- read.csv("data/BadgersFarmSurveysNoNA.csv", sep = "")
```

# Introduction and Data

Management of badgers on Welsh and British farms is a controversial topic. While some argue that culling badger populations is necessary to control the spread of bovine tuberculosis, others argue that badgers are not the major cause of the spread of disease and that culling is inhumane, especially when badger vaccination strategies are an option.

We consider data from observational surveys of 36 farms over a period of three years. The data are available on Sakai under Resources, in the BadgersFarmSurveysNoNA.txt file. Each farm (identified by the variable farm_code_numeric) was observed up to eight times (once per season for a two year period). The primary outcome, Signs_in_yard, is whether badger activity (e.g., carcasses of their prey, badger feces, indications of digging) was present in the farmyard.

## Research questions
* What factors relate to presence of badger activity in the farmyard?
* Estimate the correlation over time in badger activity and farm-specific heterogeneity in the tendency to have badger activity.

# EDA

## Examine outcome variable: signs_in_yard

There are 230 0's and 43 1's. 

```{r}
table(badgers$Signs_in_yard)
```


## Examine counts of outcome by predictors 

```{r}
# No setts in field
ggplot(badgers, aes(x = as.factor(Signs_in_yard), y = No_setts_in_fields, fill = Signs_in_yard)) + 
  geom_boxplot() + 
  theme(legend.position = "none") + 
  labs(x = "Signs in Yard", 
       title = "Signs_in_yard vs. No_setts_in_fields")
```

```{r}
# No active setts in fields
ggplot(badgers, aes(x = as.factor(Signs_in_yard), y = No_active_setts_in_fields, fill = Signs_in_yard)) + 
  geom_boxplot() + 
  theme(legend.position = "none") + 
  labs(x = "Signs in Yard", 
       title = "Signs_in_yard vs. No__active_setts_in_fields")
```

```{r}
# No_buildings
ggplot(badgers, aes(x = as.factor(Signs_in_yard), y = No_buildings, fill = Signs_in_yard)) +
  geom_boxplot() + 
  theme(legend.position = "none") + 
  labs(x = "Signs in Yard", 
       title = "Signs_in_yard vs. No_buildings")
```

```{r}
# No_cattle_in_buidlings_yard
ggplot(badgers, aes(x = as.factor(Signs_in_yard), y = No_cattle_in_buidlings_yard, fill = Signs_in_yard)) +
  geom_boxplot() + 
  theme(legend.position = "none") + 
  labs(x = "Signs in Yard", 
       title = "Signs_in_yard vs. No_cattle_in_buidlings_yard")
```

```{r}
# No_cattle_in_buidlings_yard
ggplot(badgers, aes(x = as.factor(Signs_in_yard), y = No_cattle_in_buidlings_yard, fill = Signs_in_yard)) +
  geom_boxplot() + 
  theme(legend.position = "none") + 
  labs(x = "Signs in Yard", 
       title = "Signs_in_yard vs. No_cattle_in_buidlings_yard")
```

```{r}
# season
table(badgers$Signs_in_yard, badgers$Season)
```


```{r}
# binary predictors
prop.table(table(badgers$Signs_in_yard, badgers$Accessible_feed_present))
prop.table(table(badgers$Signs_in_yard, badgers$Accessible_cattle_house_present))
prop.table(table(badgers$Signs_in_yard, badgers$Accessible_feed_store_present))
prop.table(table(badgers$Signs_in_yard, badgers$Grass_silage))
prop.table(table(badgers$Signs_in_yard, badgers$Cereal_silage))
prop.table(table(badgers$Signs_in_yard, badgers$HayStraw))
prop.table(table(badgers$Signs_in_yard, badgers$Cereal_grains))
prop.table(table(badgers$Signs_in_yard, badgers$Concentrates))
prop.table(table(badgers$Signs_in_yard, badgers$Proteinblocks))
prop.table(table(badgers$Signs_in_yard, badgers$Sugarbeet))
prop.table(table(badgers$Signs_in_yard, badgers$Vegetables))
prop.table(table(badgers$Signs_in_yard, badgers$Molasses))
```

```{r}
ggplot(badgers, aes(x = Accessible_feed_present, fill = as.factor(Signs_in_yard))) + 
  geom_bar(position = "fill") + 
  labs(title = "Accessible_feed_present vs. Signs_in_yard") + 
  theme(legend.position="bottom")
```

```{r}
ggplot(badgers, aes(x = Accessible_cattle_house_present, fill = as.factor(Signs_in_yard))) + 
  geom_bar(position = "fill") + 
  labs(title = "Accessible_cattle_house_present vs. Signs_in_yard") + 
  theme(legend.position="bottom")
```

helpful 
```{r}
ggplot(badgers, aes(x = Accessible_feed_store_present, fill = as.factor(Signs_in_yard))) + 
  geom_bar(position = "fill") + 
  labs(title = "Accessible_feed_store_present vs. Signs_in_yard") + 
  theme(legend.position="bottom")
```

```{r}
ggplot(badgers, aes(x = Grass_silage, fill = as.factor(Signs_in_yard))) + 
  geom_bar(position = "fill") + 
  labs(title = "Grass_silage vs. Signs_in_yard") + 
  theme(legend.position="bottom")
```

```{r}
ggplot(badgers, aes(x = Cereal_silage, fill = as.factor(Signs_in_yard))) + 
  geom_bar(position = "fill") + 
  labs(title = "Cereal_silage vs. Signs_in_yard") + 
  theme(legend.position="bottom")
```

helpful
```{r}
ggplot(badgers, aes(x = HayStraw, fill = as.factor(Signs_in_yard))) + 
  geom_bar(position = "fill") + 
  labs(title = "HayStraw vs. Signs_in_yard") + 
  theme(legend.position="bottom")
```

```{r}
ggplot(badgers, aes(x = Cereal_grains, fill = as.factor(Signs_in_yard))) + 
  geom_bar(position = "fill") + 
  labs(title = "Cereal_grains vs. Signs_in_yard") + 
  theme(legend.position="bottom")
```

helpful
```{r}
ggplot(badgers, aes(x = Concentrates, fill = as.factor(Signs_in_yard))) + 
  geom_bar(position = "fill") + 
  labs(title = "Concentrates vs. Signs_in_yard") + 
  theme(legend.position="bottom")
```

helpful
```{r}
ggplot(badgers, aes(x = Proteinblocks, fill = as.factor(Signs_in_yard))) + 
  geom_bar(position = "fill") + 
  labs(title = "Proteinblocks vs. Signs_in_yard") + 
  theme(legend.position="bottom")
```

helpful
```{r}
ggplot(badgers, aes(x = Sugarbeet, fill = as.factor(Signs_in_yard))) + 
  geom_bar(position = "fill") + 
  labs(title = "Sugarbeet vs. Signs_in_yard") + 
  theme(legend.position="bottom")
```

helpful
```{r}
ggplot(badgers, aes(x = Vegetables, fill = as.factor(Signs_in_yard))) + 
  geom_bar(position = "fill") + 
  labs(title = "Vegetables vs. Signs_in_yard") + 
  theme(legend.position="bottom")
```

helpful
```{r}
ggplot(badgers, aes(x = Molasses, fill = as.factor(Signs_in_yard))) + 
  geom_bar(position = "fill") + 
  labs(title = "Molasses vs. Signs_in_yard") + 
  theme(legend.position="bottom")
```


## Random intercept

```{r}
# farm code numeric
table(badgers$Signs_in_yard, badgers$farm_code_numeric)
```




# Modeling 

# unable to converge

```{r}
glmer(Signs_in_yard ~ No_active_setts_in_fields + factor(HayStraw) +
        (1 + Year | farm_code_numeric), data = badgers, 
      family = binomial(link = "logit"), 
      control = glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 2e5)))
```


Bayesian model converges

```{r}
brm(Signs_in_yard ~ No_active_setts_in_fields + factor(HayStraw) +
        (1 + Year | farm_code_numeric), 
    data = badgers, 
    family = binomial, 
    control = list(adapt_delta = 0.95))
```



---
title: "Case Study 2"
author: "Marc Brooks (Checker), Bo Liu (Programmer), Shirley Mathur (Writer), Aasha Reddy (Presenter)"
date: "11/2/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, 
                      fig.align = 'center')
```

```{r, warning=FALSE}
library(tidyverse)
library(lme4)
library(rstan)
library(brms)
library(knitr)
library(kableExtra)
library(patchwork)
library(lubridate)
library(gridExtra)
library(influence.ME)

options(scipen = 0, digits = 4)
ggplot2::theme_set(ggplot2::theme_bw())
```


```{r}
#load data
registered <- read.delim("../data/voter_stats_20201103.txt")
voted <- read.delim("../data/history_stats_20201103.txt")
```

# Introduction 

The North Carolina State Board of Elections (NCSBE) is the agency charged with the administration of the elections process and campaign finance disclosure and compliance. Among other things, they provide voter registration and turnout data online. Our goal in this case study is to use the NC voter files for the general elections in November 2020 to identify/estimate how different groups voted in the 2020 elections (out of those registered).

## Research Questions 

1) How did different demographic subgroups vote in the 2020 general elections? For example, how did the turnout for males compare to the turnout for females after controlling for other potential predictors?
--> examine fixed effects for gender

2) Did the overall probability or odds of voting differ by county in 2020? Which counties differ the most from other counties?
--> random intercept for county

3) How did the turnout rates differ between females and males for the different party affiliations?
--> interactionb between gender and party_cd

4) How did the turnout rates differ between age groups for the different party affiliations?
--> interaction between age and party_cd

# Data and cleaning 
We have two datasets that we will merge: voter_stats_20201103.txt contains information about the aggregate counts of registered voters by the demographic variables, and history_stats_20201103.txt contains information about the aggregate counts of voters who actually voted by the demographic variables. We first clean the data. 

Our outcome variable of interest needs to be created. We are examining the turnout of voters, and we have counts of total registered voters in one dataset (we will call this dataset "registered"), and counts of people who actually voted in another dataset (we will call this dataset "voted"). We will end up wanting one column for successes (number of people who actually voted), and one column for total number of people who were elligible to vote (total registered). 

First, we note the variables we definitely would like to keep in our final dataset to answer our questions of interest. From the registered dataset, we would like to keep total registered voters. From the voted dataset, we would like to keep `total voters`. We would also like to keep `sex_code`, `age`, and `county_desc` from both datasets. Additional variables of interest include `party_cd`, `race_code`, `ethnic_code` which appear in both datasets, so we can merge on these. From the voted dataset, we will not keep `voting_method`, `voting_method_desc`, and `voted_party_cd` since they do not appear in the registered dataset.  

We note that in the registered dataset, `precinct_abbrv` and `vtd_abbrv` will not be useful as they contain over 1000 factors each. `update_date` is also only NAs, so we will exclude that variable as well. We also will exclude `election_date` and `stats_type` as indicated in the prompt. 

```{r}
registered <- registered %>%
  dplyr::rename(total_registered = total_voters) %>%
  mutate(total_registered = as.numeric(total_registered))

voted <- voted %>%
  select(-voting_method_desc) %>%
  mutate(total_voters = as.numeric(total_voters))
```

Overall, in the voted dataset, we would like to keep the following variables: `county_desc`, `age`, `party_cd`, `race_code`, `ethnic_code`, `sex_code`, `total_voters`, `voting_method`, `voted_party_cd`, so we will aggregate to this level using a dplyr::group_by(). [BO: This seems contradictory to what you mentioned earlier on the decision of `voting_method` & `voted_party_cd`, as well as the code implementation.] Overall, in the registered dataset, we would like to keep the following variables: `county_desc`, `party_cd`, `race_code`, `ethnic_code`, `sex_code`, `age`, `total_registered`, so we will again aggregate to this level using a dplyr::group_by(). After this, we can merge the datasets.

```{r}
v <- voted %>%
  group_by(county_desc, age, party_cd, race_code, ethnic_code, sex_code) %>%
  summarize(total_voters = sum(total_voters))

r <- registered %>%
  group_by(county_desc, party_cd, race_code, ethnic_code, sex_code, age) %>%
  summarize(total_registered = sum(total_registered))

vote <- r %>%
  left_join(v, by = c("county_desc", "age", "party_cd", "race_code",
                      "ethnic_code", "sex_code")) %>%
  mutate(total_registered = as.numeric(total_registered), 
         total_voters = as.numeric(total_voters))

```

We note that after merging, we have 6057 missing observations for voting_method, voted_party_cd, and total_voters. [BO: Did you really include `voting_method` and `voted_party_cd`? Might need to change the narration.] This is because there were demographic/geographic groups in registered dataset that did not exist in the voted dataset. Additionally, the `race_code` variable has some missing data (only 2 observations). [BO: I did not see any missing data for columns except `total_voters`] Finally, we notice that some counties have instances where the total number of voters is larger than the total number of registered voters, which is impossible and will not work in our model. For these counties, we reduce the total number of voters to be equal to the total number of registered voters. [BO: 12 observations in total]

We also get rid of all rows that contain NA values for `total_registered` or `total_voters` as these are our outcome variables and it does not make sense to use missing data for outcome variables in our model. 

```{r}
vote <- data.frame(apply(vote, 2, function(x) gsub("^$|^ $", NA, x)))

apply(vote, 2, function(x) sum(is.na(x))) %>%
  kbl()

vote <- vote %>%
  mutate(total_voters = as.numeric(total_voters), 
         total_registered = as.numeric(total_registered), 
         county_desc = as.factor(county_desc), 
         party_cd = as.factor(party_cd), 
         race_code = as.factor(race_code), 
         sex_code = as.factor(sex_code), 
         ethnic_code = as.factor(ethnic_code), 
         age = as.factor(age)
         ) %>%
  mutate(total_voters = case_when(
    total_voters > total_registered ~ total_registered, 
    TRUE ~ total_voters
  ))

vote <- vote %>%
  filter(!is.na(total_voters), !is.na(total_registered))
```


```{r}
# test that all the NAs in the final dataset in voted_party_cd is correct - it is
registered %>%
  filter(county_desc == "ALAMANCE", party_cd == "CST", race_code == "B", 
         ethnic_code == "NL", sex_code == "F", age == "Age 18 - 25")

voted %>%
  filter(county_desc == "ALAMANCE", party_cd == "CST", race_code == "B", 
         ethnic_code == "NL", sex_code == "F", age == "Age 18 - 25")
```

### Final dataset: 45,849 observations (after removing NA from outcome variables)

Finally, we select a random sample of 30 counties to continue our modeling with. The 30 counties we choose are: Hyde, Edgecombe, Haywood, Clay, Montgomery, Durham, Cabarrus, Cherokee, Duplin, Orange, Bladen, Sampson, Transylvania, Davie, Surry, Stanly, Watauga, Caldwell, Anson, Robeson, Beaufort, Pender, Graham, Stokes, Martin, Lenoir, Hertford, Wilson, Randolph, and New Hanover. 

The final dataset after sampling 30 counties has 13,080 observations. 

```{r}
set.seed(99)
county_samp <- as.character(sample(unique(vote$county_desc), size = 30))

# this is a random sample, save it so report is reproducible
county_samp <- c("HYDE", "EDGECOMBE", "HAYWOOD", "CLAY", "MONTGOMERY", "DURHAM", "CABARRUS", "CHEROKEE", "DUPLIN", "ORANGE", "BLADEN", "SAMPSON", "TRANSYLVANIA", "DAVIE", "SURRY", "STANLY", "WATAUGA", "CALDWELL", "ANSON", "ROBESON", "BEAUFORT", "PENDER", "GRAHAM", "STOKES", "MARTIN", "LENOIR", "HERTFORD", "WILSON", "RANDOLPH", "NEW HANOVER")

vote <- vote %>%
  filter(county_desc %in% c(county_samp))
```


# EDA

First we de-aggregate the dataset so that we can do some EDA on it, meaning we expand the dataset to have our outcome variable, whether someone voted or not (`voted`) be 0 or 1, rather than having an aggregated count. This increases our dataset to 1,590,202 observations. Note that we will use the aggregated dataset for modeling since having over 1 million observations is computationally infeasible.

```{r}
# create a 0 variable for people who didnt vote
vote <- vote %>%
  mutate(total_nonvoters = total_registered - total_voters)

# elongate vote dataset to make it not aggregate
vote_long <- vote %>%
  pivot_longer(cols = c("total_voters", "total_nonvoters"), names_to = "voted", values_to = "freq") %>%
  mutate(voted = ifelse(voted == "total_voters", "Yes", "No")) %>%
  mutate(obs = map(freq, ~rep_len(1, .x))) %>%
  unnest() %>%
  select(-freq, -obs)
```

## Examine outcome variable: `voted`

Our outcome variable, `voted`, is binary, and equals "Yes" if the person in the dataset voted, and "No" if they did not. We see that there are 1,190,612 people who voted and 399,590 people who did not vote.

```{r, eval=FALSE}
table(vote_long$voted)
```

## Research question 2: random intercept for county

Our 2nd research question asks us to examine whether the overall probability or odds of voting differed by county in 2020. This points to inclusion of a random intercept by county. We can see that there is a small amount variation in the proportion of registered voters who voted by county. We will include this variable as our grouping variable in our logistic hierarchical model based on our research questions. 

## Research question 1: Examine fixed effects

Our first research questions asks to examine how different demographic subgroups voted, and how turnout for males compared to turnout for females after controlling for other predictors. This points to examination of different fixed effects, with a emphasis on examining gender. Thus, we use EDA to examine which fixed effects to include in our model. 

We examine plots of predictors vs. our outcome (`voted`) to decide which variables we will consider in our model selection process (should we use step-wise search using BIC?). We find the following variables show a difference between the counts of 0s and 1s in our outcome, and we consider them in our model selection process: `age`, `ethnic_code`, `race_code`, `party_cd`. Note that we will also definitely include `sex_code` as this is explicitly in our research question.  

[BO: Fixed the annotation of x axis so that each string is located exactly under the tick.]
```{r}
race_code <- ggplot(vote_long) + 
  geom_bar(aes(x = race_code, fill = voted), 
           position = "fill") + 
  labs(y = "Proportion", 
       title = "race_code") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), 
        plot.title = element_text(size = 10, hjust = 0.5), 
        axis.title.x = element_blank())

party_cd <- ggplot(vote_long) + 
  geom_bar(aes(x = party_cd, fill = voted), 
           position = "fill") + 
  labs(y = "Proportion", 
       title = "party_cd") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), 
        plot.title = element_text(size = 10, hjust = 0.5), 
        axis.title.x = element_blank())

ethnic_code <- ggplot(vote_long) + 
  geom_bar(aes(x = ethnic_code, fill = voted), 
           position = "fill") + 
  labs(y = "Proportion", 
       title = "ethnic_code") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), 
        plot.title = element_text(size = 10, hjust = 0.5), 
        axis.title.x = element_blank())

sex_code <- ggplot(vote_long) + 
  geom_bar(aes(x = sex_code, fill = voted), 
           position = "fill") + 
  labs(y = "Proportion", 
       title = "sex_code") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), 
        plot.title = element_text(size = 10, hjust = 0.5), 
        axis.title.x = element_blank())

age <- ggplot(vote_long) + 
  geom_bar(aes(x = age, fill = voted), 
           position = "fill") + 
  labs(y = "Proportion", 
       title = "age") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), 
        plot.title = element_text(size = 10, hjust = 0.5), 
        axis.title.x = element_blank())

patchwork <- (sex_code + age + ethnic_code) / (race_code + party_cd) +
  plot_layout(guides = "collect", widths = c(1, 1, 1, 1, 1))

patchwork + plot_annotation(
  title = "Proportion of registered voters who voted and did not vote by variable")

```

[BO: Fixed this plot as well - need to change scale from "free_y" to "free" so that x labels are not shared.]
```{r}
# choose this one probably - it looks better
names <- vote_long %>% 
  select(-county_desc, -total_registered) %>%
  colnames


vote_long %>% select(-county_desc, -total_registered) %>%
  pivot_longer(-voted) %>% 
  mutate(name = factor(name, levels = names)) %>%
  mutate(voted = as.factor(voted)) %>%
  mutate(type = "barplot") %>%
  ggplot() + 
  geom_bar(
    aes(x = value, fill = voted),
    position = "fill",
    data = ~subset(.x, type == "barplot")
  ) +
  facet_wrap(~name, scale = "free", ncol = 3) +
  xlab("") +
  ylab("Proportion") +
  labs(title = "Proportion of registered voters who voted (Yes) \nand did not vote (No) by variable") +
  guides(fill=guide_legend(title="Value")) +
  theme(strip.text.x = element_text(size = 6), 
        legend.position = "right", 
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```


## Research questions 3 and 4: interactions 

Research question 3 asks how the turnout rates different between males and females for different parties, and question 4 asks how turnout rates differ between age groups for the different parties. These point to `sex_code:party_cd` and `age:party_cd` interactions, respectively. We will thus include these interactions in our final model. We do not consider other interactions, but could in a future analysis. According to the below plots, we can see there is some initial evidence of different turnout rates of genders and ages by parties, and we will explore this further in our model.  

```{r, fig.height = 4}
sex_code_int <- ggplot(vote_long) + 
  geom_bar(aes(x = sex_code, fill = voted), 
           position = "fill") + 
  labs(y = "Proportion") +
  theme(axis.text.x = element_text(angle = 90, vjust = -0.5, hjust=1), 
        plot.title = element_text(size = 10, hjust = 0.5), 
        legend.position = "none") + 
  facet_wrap(~party_cd, ncol= 6)

age_int <- ggplot(vote_long) + 
  geom_bar(aes(x = age, fill = voted), 
           position = "fill") + 
  labs(y = "Proportion") +
  theme(axis.text.x = element_text(angle = 90, vjust = -0.5, hjust=1), 
        plot.title = element_text(size = 10, hjust = 0.5)) + 
  facet_wrap(~party_cd, ncol = 6)

patchwork <- sex_code_int / age_int
  plot_layout(guides = "collect", widths = c(1, 1))

patchwork + plot_annotation(
  title = "Proportion of registered voters who voted and did not vote \nvs. gender and age by party")
```

We also assess other potential interactions, and find that `sex_code:race_code` and  `party_cd:race_code` could be potential interactions which we test in our model selection process (see plots in appendix).



## Assessing random slopes 
?? maybe wait until presentations to see what other groups do

# Model selection and specification
Next, We do step-wise???? selection using BIC, starting with the base model of the random intercept for county, and a fixed effects for `sex_code`, `age`, `party_cd`, `sex_code:party_cd`, and `age:party_cd` based on our research questions. We use BIC to select other potential fixed effect predictors. Based on step-wise selection, we choose our final model to be the following:

BASE MODEL:
- random intercept county
- fixed effects: `sex_code`, `age`, `party_cd` 
- interactions: `sex_code:party_cd`, `age:party_cd`
- test (from EDA): `race_code`, `ethnic_code` `sex_code:race_code`, `party_cd:race_code` (this is basically all the other predictors, and some interactions)


1) How did different demographic subgroups vote in the 2020 general elections? For example, how did the turnout for males compare to the turnout for females after controlling for other potential predictors?
--> examine fixed effects for gender

2) Did the overall probability or odds of voting differ by county in 2020? Which counties differ the most from other counties?
--> random intercept for county

3) How did the turnout rates differ between females and males for the different party affiliations?
--> interactionb between gender and party_cd

4) How did the turnout rates differ between age groups for the different party affiliations?
--> interaction between age and party_cd


# Old specification from lab 9 - we should use the aggregated version

$$
y_{ij} \mid \pi_{ij} \stackrel{\mathrm{iid}}{\sim} \mathrm{Ber}(\pi_{ij}),
\quad
\mathrm{logit}(
\pi_{ij}
) = \boldsymbol{x}_{ij}^\mathrm{T}\boldsymbol{\beta} + b_i,
\quad
b_i \sim N(0, \sigma^2),
$$

where $y_{ij}$ is the `Signs_in_yard` indicator for observation $j$ in farm $i$ (random intercept indexed by $i$). $\boldsymbol{x}_{ij}^\mathrm{T}$ has 2 entries, the first being 1 for the intercept and the other one being our fixed effect `No_setts_in_field`. 


















# Appendix

# Code Appendix

```{r ref.label=knitr::all_labels(), echo=TRUE, eval=FALSE}

```

# Plot Appendix

Testing Interactions 

```{r}
# Interactions
####### sex:code ###############################################################
# sex_code:race_code
ggplot(vote_long) + 
  geom_bar(aes(x = sex_code, fill = voted), 
           position = "fill") + 
  labs(y = "Proportion") +
  theme(axis.text.x = element_text(angle = 90, vjust = -0.5, hjust=1), 
        plot.title = element_text(size = 10, hjust = 0.5), 
        legend.position = "none") + 
  facet_wrap(~race_code, ncol= 6)


# sex_code:ethnic_code
ggplot(vote_long) + 
  geom_bar(aes(x = sex_code, fill = voted), 
           position = "fill") + 
  labs(y = "Proportion") +
  theme(axis.text.x = element_text(angle = 90, vjust = -0.5, hjust=1), 
        plot.title = element_text(size = 10, hjust = 0.5), 
        legend.position = "none") + 
  facet_wrap(~ethnic_code, ncol= 6)

# sex_code:age
ggplot(vote_long) + 
  geom_bar(aes(x = sex_code, fill = voted), 
           position = "fill") + 
  labs(y = "Proportion") +
  theme(axis.text.x = element_text(angle = 90, vjust = -0.5, hjust=1), 
        plot.title = element_text(size = 10, hjust = 0.5), 
        legend.position = "none") + 
  facet_wrap(~age, ncol= 6)

######## party_cd ##############################################################
# party_cd:race_code
ggplot(vote_long) + 
  geom_bar(aes(x = party_cd, fill = voted), 
           position = "fill") + 
  labs(y = "Proportion") +
  theme(axis.text.x = element_text(angle = 90, vjust = -0.5, hjust=1), 
        plot.title = element_text(size = 10, hjust = 0.5), 
        legend.position = "none") + 
  facet_wrap(~race_code, ncol= 6)

# party_cd:ethnic_code
ggplot(vote_long) + 
  geom_bar(aes(x = party_cd, fill = voted), 
           position = "fill") + 
  labs(y = "Proportion") +
  theme(axis.text.x = element_text(angle = 90, vjust = -0.5, hjust=1), 
        plot.title = element_text(size = 10, hjust = 0.5), 
        legend.position = "none") + 
  facet_wrap(~ethnic_code, ncol= 6)

###### ethnic_code #############################################################
# ethnic_code:race_code
ggplot(vote_long) + 
  geom_bar(aes(x = ethnic_code, fill = voted), 
           position = "fill") + 
  labs(y = "Proportion") +
  theme(axis.text.x = element_text(angle = 90, vjust = -0.5, hjust=1), 
        plot.title = element_text(size = 10, hjust = 0.5), 
        legend.position = "none") + 
  facet_wrap(~race_code, ncol= 6)

# ethnic_code:age
ggplot(vote_long) + 
  geom_bar(aes(x = ethnic_code, fill = voted), 
           position = "fill") + 
  labs(y = "Proportion") +
  theme(axis.text.x = element_text(angle = 90, vjust = -0.5, hjust=1), 
        plot.title = element_text(size = 10, hjust = 0.5), 
        legend.position = "none") + 
  facet_wrap(~age, ncol= 6)
```

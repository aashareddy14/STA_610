---
title: "Case Study 1"
author: "Marc Brooks, Bo Liu, Shirley Mathur, Aasha Reddy"
date: "10/6/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```


To do:

Data cleaning (Shirley)
* Delete levels of mgstr that are not 5, 10, 40
* Delete year = 1969 
* Don't use missing data - ignore
* combine source into internet (categorical)


EDA (Marc)
* boxplot for source 
* check for interactions
* (wait until after presetnation) check for random slopes using EDA - choose 5 random states

Modeling (Bo)
* Don't use city 
* Group by state - log of ppm distribution is very similar across regions. Compare across region variances to within region variances - if it within is smaller means are more liekly to be the same. 
* use stepwise selection with BIC - start with base model and add covariates one by one. Exhaustive search (16)
* start with base model of only random intercepts (don't think about random slopes until after presetnation)
* primary_reason drop this variable - make a boxplot to see if log ppm distribution is different for price. From Mark's plot it doesn't look like they are different, so we can probably exclude this variable. Bo may explore this further - mention that if we had more time we could look into this more. 
* time - seasonality. Use quarter as a categorical variable. Maybe there is not a strong seasonal affect (looking at the boxplot). 
* use year as numerical variable (continuous) to account for potential inflation. 
* mgstr - include as a categorical 
* bulk purchase - we will include
* variables to include - log(ppm) ~ (1|state) + year + mgstr + bulk_purchase + source 
* check 2 models - check with 2004 and 2000 and then without these years and see how much it changes

Slides (Aasha)


```{r}
library(tidyverse)
library(lme4)
library(rstan)
library(brms)
library(knitr)
library(kableExtra)
library(lubridate)
library(gridExtra)

options(scipen = 0, digits = 4)
ggplot2::theme_set(ggplot2::theme_bw())
knitr::opts_chunk$set(
  fig.align = 'center', fig.width=5, fig.height=3, echo = FALSE
)
```


```{r}
#load data
load("streetrx.RData")

# GROUP 1 - METHADONE
# filter data for only methadone
streetrx <- streetrx %>%
  filter(api_temp == "methadone")
```

# Introduction, Data and Research Questions

Prescription opioid diversion and abuse are major public health issues, and street prices provide an indicator of drug availability, demand, and abuse potential. Using StreetRx data, we aim to investigate factors related to the price per mg of Methadone. 

StreetRx (streetrx.com) is a web-based citizen reporting tool enabling real-time collection of street price data on diverted pharmaceutical substances. Based on principles of crowdsourcing for public health surveillance, the site allows users to anonymously report prices they paid or heard were paid for diverted prescription drugs. User-generated data offers intelligence into an otherwise opaque black market, providing a novel data set for public health surveillance, specifically for controlled substances.

Our goal is to investigate factors related to the price per mg of Methadone, accounting for potential clustering by location and exploring heterogeneity in pricing by location. Our data contains the following factors, and we will explore how the factors in the dataset are or are not associated with pricing per milligram. 

## Questions:
* Which variables are associated with pricing per milligram of Methadone? 
* Is there heterogeneity in pricing of Methadone by location? 

```{r}
# variable description table
tibble(Variable = names(streetrx),
Description = c("Price per mg (outcome of interest)",
                "	Year and quarter drug was purchased",
                "Date of the reported purchase
",
                "city purchased",
                "state purchased",
"country purchased",
"northeast, midwest, west, south, or other/unknown
",
"source of information",
"active ingredient of drug of interest, in our case Methadone)
",
"formulation of the drug (e.g., pill, patch, suppository)
",
"dosage strength in mg of the units purchased
",
"indicator for purchase of 10+ units at once
",
"primary reason for purchase"
)) %>%
  kbl(caption = "Variable Descriptions", 
      position = "HOLD")
```


# Exploratory Analysis and Cleaning

We first examine missing data in the streetrx data. We substitute NA for all missing values. We see that some variables, such as ppm, city, source, mgstr and primary_reason have many missing values. For the purpose of our model, we will not use the source or primary_reason variable, as they contain the most missing observations. Source contains links to websites where individuals purchased the Methadone, which will not be helpful in the model. 

We also note that individuals self-report their city, state, and country, so there are some data entry errors. For instance, some observations report purchased in "New York" vs. "New York Manhattan" vs. "New York City", which all refer to the same city. Thus, this variable may not be reliable as a grouping variable to explore heterogeneity within location. This is not an issue with State, so we choose to use state as our grouping variable. We also note that all purchases were made in the USA. 

```{r}
# code missing data
streetrx <- data.frame(apply(streetrx, 2, function(x) gsub("^$|^ $", NA, x)))

# table of variables with missing data
tibble(
  Variable = names(streetrx), 
  `Number Missing` = apply(streetrx, 2, function(x) sum(is.na(x))),
  `Proportion Missing` = apply(streetrx, 2, function(x) mean(is.na(x)))
) %>%
  kbl(caption = "Number of observations missing per variable",
    position = 'HOLD')

# code factors and numeric variables 
streetrx <- streetrx %>%
  mutate(ppm = as.numeric(ppm), 
         yq_pdate = as.numeric(yq_pdate),
         price_date = mdy(price_date),
         city = as.factor(city), 
         state = as.factor(state),
         country = as.factor(country),
         USA_region = as.factor(USA_region),
         source = as.factor(source),
         form_temp = as.factor(form_temp),
         mgstr = as.numeric(mgstr),
         bulk_purchase = as.factor(bulk_purchase),
         Primary_Reason = as.factor(Primary_Reason)
         )

# add year
streetrx <- streetrx %>%
  mutate(year = year(price_date))

# delete observations with missing ppm data
streetrx <- streetrx %>%
  filter(!is.na(ppm))

# delete levels of mgstr that are not 5, 10, 40
streetrx <- streetrx %>%
  filter(mgstr %in% c(5,10,40))

# delete year of 1969 as it is likely an error
streetrx <- streetrx %>%
  filter(year != 1969)

#combine all website sources as being Internet source
streetrx <- streetrx %>%
  mutate(source = as.character(source)) %>%
  mutate(source = if_else(str_detect(source, "http://"), "Internet", source)) %>%
  mutate(source = if_else(str_detect(source, ".com$"), "Internet", source)) %>%
  mutate(source = if_else(source == "Streetrx", "Internet",source)) %>%
  mutate(source = if_else(source ==  "Poopy,", "N/A", source)) %>%
  mutate(source = if_else(source == "google", "Internet", source)) %>%
  mutate(source = if_else(source == "Internet Pharmacy", "Internet", source)) %>%
  mutate(source = na_if(source, "N/A")) %>%
  mutate(source = na_if(source, "None")) %>%
  mutate(source = as.factor(source))

```

We next examine the distribution of our outcome variable, ppm (price per mg). We can see that ppm spans a large range of values, from \$0.00025/mg to \$40/mg. There are only 16 observations with a ppm > 10, and 3 with a ppm > 20. 

```{r}
ggplot(data = streetrx, aes(x = ppm)) + 
  geom_histogram(color = "white", bins = 50) + 
  labs(y = "", 
       title = "Distribution of price per mg (ppm) \nof Methadone")
```

```{r}
streetrx %>%
  filter(ppm < 10) %>%
ggplot(data = ., aes(x = ppm)) + 
  geom_histogram(color = "white", bins = 50) + 
  labs(y = "", 
       title = "Distribution of price per mg (ppm) < 10 \nof Methadone")
```

# Check for outliers


# Outline of things to do?
** Discuss questions for Michael at OH tomorrow
1) EDA/transformations/outliers
2) Build frequentist model
3) Model/variable selection/testing
4) Bayesian model?
5) conclusion 


# Questions 
* Do we have to use all variables in our model? For instance, source and primary reason do not seem helpful 
* How should we incorporate the time aspect? Can we choose to not use these variables?
* Should we choose our grouping variable to be state, since city has a lot of missing data?
* We should consider outliers for ppm - what is an outlier?

---------------------
Added by Bo

1. Missing Values.

Five variables have missing values - `ppm`, `mgstr`, `city`, `source` and `Primary_Reason`.

Observations: 
- `Primary_Reason` has almost 50\% missing data.
- `source` and `city` has medium proportion of missing data.
- `ppm` and `mgstr` are missing at the same time.

What to do with these missing values?
- `Primary_Reason`: maybe can combine to several categories.
- `ppm` (12.65\%): outcome variable. Would hurt if the imputation is not reliable. **Suggestion: 1) discard missing observations - assume MCAR; 2) MI w/ sensitivity analysis; 3) test MI reliability first.**
- `source` (37.61\%): maybe try categorical - `Personal`, `Internet`, `Heard`, `Other`.
- `city` (33.24\%): basically can do nothing - delete.
- `mgstr` (12.65\%): depend on how you treat `ppm`. If missing data in `ppm` are discarded, then there are no missingness in `mgstr`.

2. Distribution of Variables

1) outcome: `ppm`

```{r}
ppm_hist1 <- streetrx %>%
  ggplot(aes(x = ppm, y = ..density..)) +
  geom_histogram(bins = 30, alpha = 0.4) +
  geom_density(color = "navyblue", adjust = 5)

ppm_hist2 <- streetrx %>%
  ggplot(aes(x = log(ppm), y = ..density..)) +
  geom_density(color = "navyblue", adjust = 5) +
  geom_histogram(bins = 30, alpha = 0.4)
  
grid.arrange(ppm_hist1, ppm_hist2, ncol=2)
```

2) `mgstr`

```{r}
mgstr_hist1 <- streetrx %>%
  ggplot(aes(x = mgstr, y = ..density..)) +
  geom_density(color = "navyblue", adjust = 1) + 
  geom_histogram(bins = 30, alpha = 0.4)

mgstr_hist2 <- streetrx %>%
  ggplot(aes(x = log(mgstr), y = ..density..)) +
  geom_density(color = "navyblue", adjust = 1) +
  geom_histogram(bins = 30, alpha = 0.4)
  
grid.arrange(mgstr_hist1, mgstr_hist2, ncol=2)
```

Only three main levels of `mgstr`: 5mg, 10mg and 40mg.

```{r}
streetrx %>% 
  filter(!is.na(mgstr)) %>%
  filter(!mgstr %in% c(5, 10, 40)) %>% 
  pull(mgstr)
```

3) Dates

```{r}
streetrx %>% 
  mutate(
    year = yq_pdate %/% 10, 
    quarter = yq_pdate %% 10
  ) %>%
  group_by(year) %>% 
  summarize(n = n())
```

1969 seems to be erroneous.

```{r}
streetrx %>%
  filter(year(price_date) != yq_pdate %/% 10)
```

```{r}
streetrx %>%
  filter((month(price_date) - 1) %/% 3 != yq_pdate %% 10 - 1)
```

Two dates are consistent.

4) Geographical information

```{r}
streetrx %>% group_by(USA_region) %>% summarize(n = n())
```

```{r}
streetrx %>% 
  group_by(state) %>% 
  summarize(n = n()) %>% 
  arrange(desc(n))
```

Some states have very few observations - might be more stable to use a hierarchical model. **Think of whether to use regional information (another level of hierarchy)**

5) `form_temp`

```{r}
streetrx %>% group_by(form_temp) %>% summarize(n = n())
```

```{r}
streetrx %>% group_by(form_temp, is.na(mgstr)) %>% summarize(n = n())
```

**All syrup/liquid rows do not have `mgstr` values. Basically we do not have any outcome data for syrup/liquid drugs.**

6) `bulk_purchase`

```{r}
streetrx %>% group_by(bulk_purchase) %>% summarize(n = n())
```

3. Association with outcome `ppm`

1) `mgstr`

```{r}
ggplot(streetrx) +
  geom_point(aes(x = mgstr, y = log(ppm))) +
  geom_point(aes(x = mgstr, y = mean),
             data = streetrx %>% 
               group_by(mgstr) %>% 
               summarize(mean = mean(log(ppm))),
             color = "red"
)
```

Seems that there is a slight association.

```{r}
cor(streetrx$ppm, streetrx$mgstr, use = "complete.obs")
```

2) Dates

```{r}
streetrx %>% mutate(quarter = yq_pdate %% 10) %>%
  ggplot() + 
  geom_boxplot(aes(x = quarter, y = log(ppm), group = quarter))
```

```{r}
streetrx %>% filter(yq_pdate >= 20000) %>%
  mutate(year = yq_pdate %/% 10) %>%
  ggplot() + 
  geom_boxplot(aes(x = year, y = log(ppm), group = year))
```

```{r}
streetrx %>% 
  filter(yq_pdate >= 20000) %>%
  mutate(days = difftime(price_date, '2000-01-01', units = "days")) %>%
  ggplot() +
  geom_point(aes(x = days, y = log(ppm)))
```

```{r}
streetrx %>% 
  filter(yq_pdate >= 20090) %>%
  mutate(days = difftime(price_date, '2000-01-01', units = "days")) %>%
  ggplot() +
  geom_point(aes(x = days, y = log(ppm)))
```

3) Geographical information

```{r}
ggplot(streetrx) +
  geom_boxplot(aes(x = USA_region, y = log(ppm)))
```

```{r}
ggplot(streetrx) +
  geom_boxplot(aes(x = state, y = log(ppm)))
```

4) `bulk_purchase`

```{r}
ggplot(streetrx) + 
  geom_boxplot(aes(x = bulk_purchase, y = log(ppm)))
```

5) `source` and `Primary_Reason`

**Depend on how we discuss to deal with these variables.**

4. Detecting Interaction Effects

1.) `bulk_purchase` and `mgstr`

The following boxplot does reveal some slight variance in the effect of `bulk_purchace` 
on `log(ppm)` across values of `mgstr`.

```{r}
ggplot(streetrx) + 
  geom_boxplot(aes(x = bulk_purchase, y = log(ppm))) +
  facet_wrap(~mgstr)
```
2.) `source` and `mgstr`

The following boxplot does reveal some slight variance in the effect of `source` 
on `log(ppm)` across different values of `mgstr`, though some of this effect 
could be distorted by lack of observations within certain categories.

```{r}
ggplot(streetrx) + 
  geom_boxplot(aes(x = source, y = log(ppm))) +
  facet_wrap(~mgstr)
```
3.) `source` and `bulk_purchase`

The follow boxplot does not show substantial evidence that the relationship
between log(ppm) and bulk_purchace varies across source.

```{r}
ggplot(streetrx) + 
  geom_boxplot(aes(x = bulk_purchase, y = log(ppm))) +
  facet_wrap(~source)
```

4.) `bulk_purchase` and `quarter`

From the boxplot it appears that the relationship between quarter and log(ppm) 
changes slightly for different values of bulk_purchase.

```{r}
streetrx %>%
  mutate(quarter = yq_pdate %% 10) %>%
  ggplot(aes(x = as.factor(quarter), y = log(ppm))) +
  geom_boxplot() +
  facet_wrap(~ bulk_purchase)
```

5.) `mgstr` and `quarter`

There is some evidence that the effect of quarter on log(ppm) changes with the 
dosage unit.

```{r}
streetrx %>%
  mutate(quarter = yq_pdate %% 10) %>%
  ggplot(aes(x = as.factor(quarter), y = log(ppm))) +
  geom_boxplot() +
  facet_wrap(~ mgstr)
```

6.) `source` and `quarter`

We do not see strong evidence that the relationship between quarter and log(ppm) 
changes across source.

```{r}
streetrx %>%
  mutate(quarter = yq_pdate %% 10) %>%
  ggplot(aes(x = as.factor(quarter), y = log(ppm))) +
  geom_boxplot() +
  facet_wrap(~ source)
```

7.) Interactions between factor variables and year

7.1) `mgstr`

There is not strong evidence that `mgstr` effects the relationship between `year`
and `log(ppm)`.

```{r}
streetrx %>% 
  mutate(year = yq_pdate %/% 10) %>% 
  ggplot(aes(x=year, y = log(ppm)))  +
  geom_point() +
  facet_wrap(~mgstr) + 
  geom_smooth(method = "lm")  
```

```{r}
streetrx %>% 
  mutate(year = yq_pdate %/% 10) %>% 
  filter(year > 2005) %>% 
  ggplot(aes(x=year, y = log(ppm)))  +
  geom_point() +
  facet_wrap(~mgstr) + 
  geom_smooth(method = "lm")  
```
7.2) `bulk_purchase`
There is not strong evidence that `bulk_purchase` effects the relationship between `year`
and `log(ppm)`.
```{r}
streetrx %>% 
  mutate(year = yq_pdate %/% 10) %>% 
  ggplot(aes(x=year, y = log(ppm)))  +
  geom_point() +
  facet_wrap(~bulk_purchase) + 
  geom_smooth(method = "lm")  
```


```{r}
streetrx %>% 
  mutate(year = yq_pdate %/% 10) %>% 
  filter(year > 2005) %>% 
  ggplot(aes(x=year, y = log(ppm)))  +
  geom_point() +
  facet_wrap(~bulk_purchase) + 
  geom_smooth(method = "lm")  
```
7.3) `source`
There is not strong evidence that `source` effects the relationship between `year`
and `log(ppm)`.
```{r}
streetrx %>% 
  mutate(year = yq_pdate %/% 10) %>% 
  ggplot(aes(x=year, y = log(ppm)))  +
  geom_point() +
  facet_wrap(~source) + 
  geom_smooth(method = "lm")  
```


```{r}
streetrx %>% 
  mutate(year = yq_pdate %/% 10) %>% 
  filter(year > 2005) %>% 
  ggplot(aes(x=year, y = log(ppm)))  +
  geom_point() +
  facet_wrap(~source) + 
  geom_smooth(method = "lm")  
```

Outside of `mgstr` and `quarter`,  `bulk_purchase` and `quarter`, `source` and,
and `mgstr` `bulk_purchase` and `mgstr` there was not strong evidence for other 
interaction effects. Even for those listed above the evidence was not substantial 
in our EDA, and some of the variation is likely due to a lack of observations
for certain interaction terms.


5. Model

**I do not have much information about what the best model should be, given that we are still in early EDA. Nevertheless, a priori I have some preference on what to use / what not to use.**

1) Grouping variable

- `USA_region` and `state` are natural grouping variables - and required for the analysis purpose.
- Grouping on binary variables is equivalent to a random slope for it. If we decide to put a random slope on a binary variable, we should put it as a grouping variable for ease to interpret.
- Other categorical variables are subject on how many levels we keep.

2) Base model

State: $s$. 
$$y_{is} = \mu + \alpha_{s} + \epsilon_{is}.$$

See how much heterogeniety.

*May compare the fitted variance of regional level means and state level means. If regional level means have larger variance, it might indicate a clustering effect within regions.*

```{r}
model_plain <- 
  lmer(log(ppm) ~ 1 + (1 | state), data = streetrx, REML = F)
summary(model_plain)$AICtab
```

3) Adding predictors

Criterion: BIC(?) for Bayesian predictor selection.

We do an exhaustive search.

```{r}
exhaustive_search <- function(raw_model, vars, data, REML = F) {
  y_name <- deparse(raw_model[[2]])
  group_name <- deparse(raw_model[[3]])
  id <- 0 : (2^length(vars) - 1)
  construct_model <- function(.id){
    subset <- (.id %/% 2^(0:(length(vars) - 1))) %% 2 == 1
    if (all(subset == F)){
      RHS <- paste0(c("1", group_name), collapse = ' + ')
    }
    else {
      RHS <- paste0(c(vars[subset], group_name), collapse = ' + ')
    }
    paste(y_name, RHS, sep = ' ~ ')
  }
  run_model <- function(.id){
    model_str <- construct_model(.id)
    model_formula <- as.formula(model_str)
    res <- lmer(model_formula, REML = REML, data = data)
    return (summary(res)$AICtab)
  }
  
  bind_cols(
    model = sapply(id, construct_model),
    as.data.frame(t(sapply(id, run_model)))
  )
}
```

```{r}
ex_result <- exhaustive_search(
  raw_model <- log(ppm) ~ (1 | state),
  vars = c("year", "mgstr", "bulk_purchase", "source"),
  data = streetrx,
  REML = F
)
```

```{r}
ex_result
```